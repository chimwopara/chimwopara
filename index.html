<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life's Journey: A 3D Portfolio Game</title>
<style>
/* --- General Setup --- */
body { 
    margin: 0; 
    overflow: hidden; 
    background-color: #111; 
    color: #fff; 
    font-family: 'Inter', sans-serif; 
}
canvas { 
    display: block; 
}
#ui-container { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
}

/* --- Car Selection Screen --- */
#car-selection-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    pointer-events: auto;
    opacity: 1;
    transition: opacity 0.5s ease-out;
    z-index: 10;
}
#car-selection-screen.hidden {
    opacity: 0;
    pointer-events: none;
}
#car-selection-screen h1 {
    font-size: 2.5rem;
    margin-bottom: 1em;
    text-shadow: 0 0 15px rgba(255,255,255,0.5);
}
#car-options {
    display: flex;
    flex-direction: column;
    gap: 1.5em;
}
.car-option { 
    background: rgba(40, 40, 40, 0.7);
    border: 1px solid #444; 
    padding: 1.5em; 
    border-radius: 15px; 
    cursor: pointer; 
    transition: transform 0.3s, background 0.3s, border-color 0.3s;
    width: 280px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.car-option:hover { 
    transform: translateY(-10px);
    background: rgba(60, 60, 60, 0.9);
    border-color: #00aaff;
}
.car-preview-canvas {
    width: 250px;
    height: 150px;
    margin-bottom: 1em;
    border-radius: 10px;
}
.car-option h3 {
    margin: 0 0 0.25em 0;
    font-size: 1.5rem;
    color: #00aaff;
}
.car-option p {
    margin: 0;
    color: #ccc;
}

/* --- Dashboard UI --- */
#dashboard-ui {
    display: none; /* Hidden by default */
    background: rgba(0, 0, 0, 0.5);
    padding: 10px 20px;
    border-radius: 15px 15px 0 0;
    margin-bottom: 10px;
    display: flex;
    gap: 25px;
    font-size: 1.2rem;
    text-shadow: 0 0 5px #00aaff;
    pointer-events: auto;
    opacity: 0;
    transition: opacity 0.5s ease-in;
}
#dashboard-ui.visible {
    opacity: 1;
}
#speed-display, #distance-display, #checkpoint-display {
    color: #00ddff;
}

/* --- Media Player UI --- */
#media-container { 
    display: none; 
    position: absolute; 
    bottom: 20px; 
    right: 20px; 
    background: rgba(0,0,0,0.85); 
    padding: 1em; 
    border-radius: 15px; 
    width: 90%; 
    max-width: 400px; 
    pointer-events: auto; 
    border: 1px solid #555;
    backdrop-filter: blur(5px);
}
#media-video-player { 
    width: 100%; 
    height: auto; 
    border-radius: 10px; 
    background: #000;
}
#close-media-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #ff4d4d;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    line-height: 30px;
    text-align: center;
}

/* --- Weather & Responsiveness --- */
#weather-overlay { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    background: transparent; 
    transition: background 2s; 
}

@media (min-width: 768px) {
    #car-selection-screen h1 {
        font-size: 3.5rem;
    }
    #car-options {
        flex-direction: row;
        gap: 2em;
    }
    #dashboard-ui {
        font-size: 1.5rem;
        padding: 15px 30px;
        gap: 40px;
    }
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="ui-container">
    <div id="car-selection-screen">
        <h1>Choose Your Ride</h1>
        <div id="car-options">
            <div class="car-option" data-car="sedan">
                <canvas class="car-preview-canvas"></canvas>
                <h3>Sporty Sedan</h3>
                <p>A fast-paced journey awaits.</p>
            </div>
            <div class="car-option" data-car="truck">
                <canvas class="car-preview-canvas"></canvas>
                <h3>Cyber Truck</h3>
                <p>Ready for any obstacle ahead.</p>
            </div>
            <div class="car-option" data-car="van">
                <canvas class="car-preview-canvas"></canvas>
                <h3>Classic Van</h3>
                <p>For the long, scenic route.</p>
            </div>
        </div>
    </div>

    <div id="dashboard-ui">
        <div id="speed-display">Speed: 0 km/h</div>
        <div id="distance-display">Trip: 0.0 km</div>
        <div id="checkpoint-display">Next: 5.0 km</div>
    </div>
    
    <div id="media-container">
        <video id="media-video-player" controls autoplay muted loop playsinline></video>
        <button id="close-media-btn">X</button>
    </div>
</div>
<div id="weather-overlay"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// --- GLOBAL VARIABLES ---
let mainRenderer, mainScene, mainCamera;
let playerCar = null, steeringWheel = null, passengerScreenMesh = null;
let gameStarted = false;
let currentLane = 1; 
let roadSpeed = 0.2; 
const carPreviews = [];
let distanceTraveled = 0;
let nextCheckpointDistance = 5;
let isCameraAnimating = false;
let cameraAnimationStartTime;
const cameraAnimationDuration = 4000;
let startCamPos = new THREE.Vector3();
let startCamQuat = new THREE.Quaternion();
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const videoPlaylist = [
    'http://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
    'http://storage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
    'http://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
    'http://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4',
    'http://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4'
];
let currentVideoIndex = 0;

// --- INITIALIZATION ---
function init() {
    setupMainScene();
    setupCarPreviews();
    addEventListeners();
    animate();
}

// --- MAIN 3D SCENE SETUP ---
function setupMainScene() {
    mainScene = new THREE.Scene();
    mainScene.fog = new THREE.Fog(0x1a1a1a, 20, 100);

    mainCamera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000); // Adjusted FOV
    mainCamera.position.set(0, 25, 10);
    mainCamera.lookAt(0, 0, 0);

    mainRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    mainRenderer.setSize(window.innerWidth, window.innerHeight);
    mainRenderer.setClearColor(0x1a1a1a, 1);
    document.body.insertBefore(mainRenderer.domElement, document.getElementById('ui-container'));

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    mainScene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
    directionalLight.position.set(0, 20, 10);
    mainScene.add(directionalLight);

    const road = createRoad();
    mainScene.add(road);
}

// --- CAR PREVIEW SETUP ---
function setupCarPreviews() {
    const previewElements = document.querySelectorAll('.car-option');
    previewElements.forEach(el => {
        const canvas = el.querySelector('.car-preview-canvas');
        const carType = el.dataset.car;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(0, 2, 6);
        camera.lookAt(0, 0, 0);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setClearColor(0x000000, 0);
        const carMesh = createCarMesh(carType, false);
        scene.add(carMesh);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        carPreviews.push({ renderer, scene, camera, carMesh });
    });
}

// --- EVENT LISTENERS ---
function addEventListeners() {
    window.addEventListener('resize', onWindowResize, false);
    document.getElementById('car-options').addEventListener('click', selectCar);
    mainRenderer.domElement.addEventListener('click', onCanvasClick, false);
    document.getElementById('close-media-btn').addEventListener('click', hideVideoPlayer);
}

// --- GAME OBJECT CREATION ---
function createRoad() {
    const roadGroup = new THREE.Group();
    roadGroup.name = "road";
    const roadMaterial = new THREE.MeshStandardMaterial({ color: 0x2c2c2c, roughness: 0.8 });
    const roadPlane = new THREE.Mesh(new THREE.PlaneGeometry(15, 1000), roadMaterial);
    roadPlane.rotation.x = -Math.PI / 2;
    roadPlane.position.y = -0.5;
    roadGroup.add(roadPlane);
    for (let i = -495; i < 500; i += 20) {
        const mark = new THREE.Mesh(new THREE.PlaneGeometry(0.2, 8), new THREE.MeshBasicMaterial({ color: 0xffffff }));
        mark.rotation.x = -Math.PI / 2;
        mark.position.set(0, -0.49, i);
        roadGroup.add(mark);
    }
    const shoulderLineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
    const shoulderLine1 = new THREE.Mesh(new THREE.PlaneGeometry(0.15, 1000), shoulderLineMat);
    shoulderLine1.rotation.x = -Math.PI / 2;
    shoulderLine1.position.set(-7, -0.49, 0);
    const shoulderLine2 = new THREE.Mesh(new THREE.PlaneGeometry(0.15, 1000), shoulderLineMat);
    shoulderLine2.rotation.x = -Math.PI / 2;
    shoulderLine2.position.set(7, -0.49, 0);
    roadGroup.add(shoulderLine1, shoulderLine2);
    return roadGroup;
}

function createSteeringWheel() {
    const wheelGroup = new THREE.Group();
    const rimMat = new THREE.MeshStandardMaterial({ color: 0x181818, roughness: 0.5 });
    const centerMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.6 });
    const chromeMat = new THREE.MeshStandardMaterial({ color: 0xbbbbbb, metalness: 1.0, roughness: 0.2 });

    // Rim
    const rim = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.06, 16, 60), rimMat);
    wheelGroup.add(rim);

    // Center hub
    const centerHub = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.1, 0.08, 16), centerMat);
    centerHub.rotation.x = Math.PI / 2;
    wheelGroup.add(centerHub);

    // Spokes
    const spokeGeo = new THREE.BoxGeometry(0.3, 0.05, 0.05);
    const spoke1 = new THREE.Mesh(spokeGeo, centerMat);
    spoke1.position.set(-0.25, 0, 0);
    spoke1.rotation.z = Math.PI / 2.5;
    const spoke2 = new THREE.Mesh(spokeGeo, centerMat);
    spoke2.position.set(0.25, 0, 0);
    spoke2.rotation.z = -Math.PI / 2.5;
    const spoke3 = new THREE.Mesh(spokeGeo, centerMat);
    spoke3.position.y = -0.25;
    spoke3.rotation.z = Math.PI;
    wheelGroup.add(spoke1, spoke2, spoke3);

    // Main steering wheel assembly to return
    const steeringAssembly = new THREE.Group();
    steeringAssembly.add(wheelGroup);
    wheelGroup.position.z = 0.1; // Move wheel forward from pivot
    
    // Add a column
    const column = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.1, 0.4, 12), rimMat);
    column.position.z = -0.1;
    steeringAssembly.add(column);

    return steeringAssembly;
}

function createCarInterior() {
    const interior = new THREE.Group();
    const dashMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.7 });
    const screenMat = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.2, metalness: 0.5 });

    // --- Redesigned Dashboard ---
    const dashTop = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.1, 1.2), dashMat);
    dashTop.position.set(0, 0.8, 0.8);
    const dashFront = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.4, 0.1), dashMat);
    dashFront.position.set(0, 0.55, 1.35);
    interior.add(dashTop, dashFront);
    
    // --- Instrument Cluster ---
    const clusterHousing = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.25, 0.2), dashMat);
    clusterHousing.position.set(-0.5, 0.9, 0.5);
    interior.add(clusterHousing);

    // --- Passenger Screen ---
    passengerScreenMesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.4, 0.05), screenMat);
    passengerScreenMesh.position.set(0.6, 0.55, 1.3);
    passengerScreenMesh.name = "passengerScreen";
    interior.add(passengerScreenMesh);

    // --- A-Pillar and Windshield Frame ---
    const pillarMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.8 });
    
    // --- FIX: Raised the windshield frame and added right pillar ---
    const pillarHeight = 0.9; // Pillar height from dashboard to roof
    const pillarYPos = 1.25;  // Positioned on top of the dashboard
    
    const pillarLeft = new THREE.Mesh(new THREE.BoxGeometry(0.2, pillarHeight, 0.2), pillarMat);
    pillarLeft.position.set(-1.2, pillarYPos, 1.8);
    pillarLeft.rotation.y = Math.PI / 8;
    pillarLeft.rotation.z = -Math.PI / 12;
    
    const pillarRight = pillarLeft.clone();
    pillarRight.position.x = 1.2;
    pillarRight.rotation.y = -Math.PI / 8;
    pillarRight.rotation.z = Math.PI / 12;

    interior.add(pillarLeft, pillarRight);

    const windshieldTopFrame = new THREE.Mesh(new THREE.BoxGeometry(2.6, 0.15, 0.15), pillarMat);
    windshieldTopFrame.position.set(0, 1.7, 1.9); // Raised position
    interior.add(windshieldTopFrame);

    // --- Steering Wheel ---
    steeringWheel = createSteeringWheel();
    steeringWheel.position.set(-0.5, 0.6, 0.8);
    steeringWheel.rotation.x = Math.PI / 8;
    interior.add(steeringWheel);

    return interior;
}


function createCarMesh(type, createInterior = true) {
    const car = new THREE.Group();
    const carColor = { sedan: 0xdc3545, truck: 0xaaaaaa, van: 0x28a745 }[type];
    const mainMaterial = new THREE.MeshStandardMaterial({ color: carColor, metalness: 0.8, roughness: 0.4 });
    const wheelMaterial = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.1, roughness: 0.8 });
    const glassMaterial = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.9, roughness: 0.2, transparent: true, opacity: 0.8 });
    
    const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.3, 24);
    const wheelPositions = [
        new THREE.Vector3(-1.2, -0.1, 1.8), new THREE.Vector3(1.2, -0.1, 1.8),
        new THREE.Vector3(-1.2, -0.1, -1.8), new THREE.Vector3(1.2, -0.1, -1.8)
    ];
    wheelPositions.forEach(pos => {
        const wheel = new THREE.Mesh(wheelGeo, wheelMaterial);
        wheel.position.copy(pos);
        wheel.rotation.z = Math.PI / 2;
        car.add(wheel);
    });

    // Simplified exterior models for performance
    switch(type) {
        case 'truck':
            const cyberMaterial = new THREE.MeshStandardMaterial({ color: 0xC0C0C0, metalness: 1.0, roughness: 0.2 });
            const body = new THREE.Mesh(new THREE.BoxGeometry(2.5, 1.2, 5), cyberMaterial);
            body.position.y = 0.5;
            car.add(body);
            break;
        case 'sedan':
            const bodySedan = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.8, 4.5), mainMaterial);
            bodySedan.position.y = 0.3;
            const cabinSedan = new THREE.Mesh(new THREE.BoxGeometry(2.3, 0.7, 2.2), glassMaterial);
            cabinSedan.position.y = 1.05; cabinSedan.position.z = -0.4;
            car.add(bodySedan, cabinSedan);
            break;
        case 'van':
            const bodyVan = new THREE.Mesh(new THREE.BoxGeometry(2.5, 1.6, 5), mainMaterial);
            bodyVan.position.y = 0.7;
            car.add(bodyVan);
            break;
    }

    if (createInterior) {
        const interior = createCarInterior();
        car.add(interior);
    }

    car.scale.set(0.8, 0.8, 0.8);
    return car;
}

// --- GAME LOGIC ---
function selectCar(event) {
    const carOption = event.target.closest('.car-option');
    if (carOption) {
        const carType = carOption.dataset.car;
        playerCar = createCarMesh(carType, true);
        playerCar.position.y = 0;
        playerCar.position.x = currentLane * 3.75;
        
        mainScene.add(playerCar);
        
        const selectionScreen = document.getElementById('car-selection-screen');
        selectionScreen.classList.add('hidden');
        
        setTimeout(() => {
            gameStarted = true;
            carPreviews.length = 0;
            
            isCameraAnimating = true;
            cameraAnimationStartTime = performance.now();
            startCamPos.copy(mainCamera.position);
            startCamQuat.copy(mainCamera.quaternion);
        }, 500);
    }
}

function switchLaneTo(lane) {
    if (!gameStarted) return;
    if (lane === -1 || lane === 1) {
        currentLane = lane;
    }
}

function updateDashboard() {
    const speed = Math.floor(roadSpeed * 400);
    const frameDistance = (speed / 3600) * (1/60);
    distanceTraveled += frameDistance;
    nextCheckpointDistance -= frameDistance;

    if (nextCheckpointDistance <= 0) {
        nextCheckpointDistance += 5;
    }

    document.getElementById('speed-display').textContent = `Speed: ${speed} km/h`;
    document.getElementById('distance-display').textContent = `Trip: ${distanceTraveled.toFixed(1)} km`;
    document.getElementById('checkpoint-display').textContent = `Next: ${nextCheckpointDistance.toFixed(1)} km`;
}

function onWindowResize() {
    mainCamera.aspect = window.innerWidth / window.innerHeight;
    mainCamera.updateProjectionMatrix();
    mainRenderer.setSize(window.innerWidth, window.innerHeight);
}

// --- MEDIA PLAYER LOGIC ---
function onCanvasClick(event) {
    if (!passengerScreenMesh || isCameraAnimating) return;

    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, mainCamera);
    const intersects = raycaster.intersectObject(passengerScreenMesh);

    if (intersects.length > 0) {
        playNextVideo();
    }
}

function playNextVideo() {
    const mediaContainer = document.getElementById('media-container');
    const videoPlayer = document.getElementById('media-video-player');
    videoPlayer.src = videoPlaylist[currentVideoIndex];
    videoPlayer.play();
    mediaContainer.style.display = 'block';
    currentVideoIndex = (currentVideoIndex + 1) % videoPlaylist.length;
}

function hideVideoPlayer() {
    const mediaContainer = document.getElementById('media-container');
    const videoPlayer = document.getElementById('media-video-player');
    videoPlayer.pause();
    videoPlayer.src = "";
    mediaContainer.style.display = 'none';
}

// --- ANIMATION LOOP ---
function animate() {
    requestAnimationFrame(animate);

    if (!gameStarted) {
        carPreviews.forEach(preview => {
            preview.carMesh.rotation.y += 0.01;
            preview.renderer.render(preview.scene, preview.camera);
        });
    }

    if (gameStarted && playerCar) {
        const road = mainScene.getObjectByName("road");
        if (road) {
            road.position.z = (road.position.z - roadSpeed) % 20;
        }

        const targetX = currentLane * 3.75;
        playerCar.position.x += (targetX - playerCar.position.x) * 0.1;

        playerCar.traverse((child) => {
            if (child.isMesh && child.geometry.type === 'CylinderGeometry') {
                child.rotation.x -= roadSpeed;
            }
        });
        
        if (steeringWheel) {
            // Correct steering wheel rotation
            const wheelMesh = steeringWheel.children[0];
            const targetRotation = (targetX - playerCar.position.x) * 0.1;
            wheelMesh.rotation.z += (targetRotation - wheelMesh.rotation.z) * 0.2;
        }
        
        updateDashboard();

        if (isCameraAnimating) {
            const elapsedTime = performance.now() - cameraAnimationStartTime;
            let progress = Math.min(elapsedTime / cameraAnimationDuration, 1);
            progress = 0.5 - 0.5 * Math.cos(progress * Math.PI);
            
            // --- New Camera Animation Target ---
            const endCamPos = new THREE.Vector3();
            playerCar.localToWorld(endCamPos.set(-0.4, 1.2, 0.5)); 

            const lookAtPoint = new THREE.Vector3();
            playerCar.localToWorld(lookAtPoint.set(0, 1.0, 100));
            const tempMatrix = new THREE.Matrix4().lookAt(endCamPos, lookAtPoint, mainCamera.up);
            const endCamQuat = new THREE.Quaternion().setFromRotationMatrix(tempMatrix);

            mainCamera.position.copy(startCamPos).lerp(endCamPos, progress);
            mainCamera.quaternion.copy(startCamQuat).slerp(endCamQuat, progress);

            if (progress >= 1) {
                isCameraAnimating = false;
                playerCar.add(mainCamera);
                // --- New Final Camera Position ---
                mainCamera.position.set(-0.4, 1.2, 0.5); 
                document.getElementById('dashboard-ui').classList.add('visible');
            }
        }
    }

    mainRenderer.render(mainScene, mainCamera);
}

// --- CONTROLS ---
document.addEventListener('keydown', (event) => {
    if (!gameStarted || isCameraAnimating) return;
    if (event.key === 'ArrowLeft') {
        switchLaneTo(1);
    } else if (event.key === 'ArrowRight') {
        switchLaneTo(-1);
    }
});

let touchStartX = 0;
let isDragging = false;
document.body.addEventListener('touchstart', (e) => {
    if (!gameStarted || isCameraAnimating) return;
    touchStartX = e.touches[0].clientX;
    isDragging = true;
});

document.body.addEventListener('touchmove', (e) => {
    if (!isDragging || !gameStarted) return;
    const touchX = e.touches[0].clientX;
    const deltaX = touchX - touchStartX;
    if (Math.abs(deltaX) > 50) {
        if (deltaX < 0) { 
            switchLaneTo(1);
        } else { 
            switchLaneTo(-1);
        }
        isDragging = false;
    }
});

document.body.addEventListener('touchend', () => { isDragging = false; });

// --- START THE APP ---
init();
</script>
</body>
</html>
